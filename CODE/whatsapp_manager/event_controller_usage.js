/**
 * Exemplo de uso do Event Controller para o projeto WhatsApp
 * 
 * Demonstra como integrar o WAMonitoringService e EventController
 * no servidor WhatsApp existente.
 */

import { EventEmitter } from 'events';
import { WAMonitoringService, EventController, emitEvent } from './event_controller.js';
import { SupabaseRepository } from './supabase_repository.js';
import { ProviderFiles } from './provider_file_service.js';
import { EVENTS, DEFAULT_CONFIG } from './event_config.js';

// -- CONSTANTS

// -- TYPES

// -- VARIABLES

// -- FUNCTIONS

/**
 * Configura o Event Controller para o servidor WhatsApp
 */
async function setupEventControllerForWhatsApp() {
    console.log('üîß Configurando Event Controller para WhatsApp...');

    // Cria o event emitter principal
    const eventEmitter = new EventEmitter();
    
    // Configura√ß√µes espec√≠ficas para o projeto WhatsApp
    const configService = {
        get: (key) => {
            const configs = {
                'DATABASE': {
                    SAVE_DATA: { INSTANCE: true },
                    CONNECTION: { CLIENT_NAME: DEFAULT_CONFIG.CLIENT_NAME }
                },
                'CACHE': {
                    REDIS: { ENABLED: false, SAVE_INSTANCES: false }
                },
                'PROVIDER': { ENABLED: false },
                'CHATWOOT': { ENABLED: false },
                'DEL_INSTANCE': 60
            };
            return configs[key];
        }
    };

    // Inicializa reposit√≥rios
    const supabaseRepository = new SupabaseRepository();
    const providerFiles = new ProviderFiles();
    
    // Cache services mock (implemente conforme necess√°rio)
    const cache = {
        delete: async (key) => console.log(`Cache delete: ${key}`),
        keys: async () => []
    };
    
    const chatwootCache = { ...cache };
    const baileysCache = { ...cache };

    // Cria o monitoring service
    const monitoringService = new WAMonitoringService(
        eventEmitter,
        configService,
        supabaseRepository,
        providerFiles,
        cache,
        chatwootCache,
        baileysCache
    );

    // Cria o event controller para integra√ß√µes
    const eventController = new EventController(
        supabaseRepository,
        monitoringService,
        true, // integrationStatus
        'webhook' // integrationName
    );

    // Configura event listeners espec√≠ficos para WhatsApp
    setupWhatsAppEventListeners(eventEmitter, monitoringService, eventController);

    console.log('‚úÖ Event Controller configurado para WhatsApp');
    
    return { eventEmitter, monitoringService, eventController };
}

/**
 * Configura event listeners espec√≠ficos para WhatsApp
 */
function setupWhatsAppEventListeners(eventEmitter, monitoringService, eventController) {
    // Listener para reconex√£o falhada
    eventEmitter.on(EVENTS.RECONNECT_FAILED, async (instanceName) => {
        console.log(`üö® Reconex√£o falhou para: ${instanceName}`);
        
        try {
            // Emite evento para integra√ß√µes
            await emitEvent({
                instanceName,
                origin: 'whatsapp',
                event: 'RECONNECT_FAILED',
                data: { instanceName, timestamp: new Date().toISOString() },
                serverUrl: process.env.SERVER_URL || 'http://localhost:3000',
                dateTime: new Date().toISOString(),
                sender: 'whatsapp-manager',
                local: false,
                integration: ['webhook', 'email']
            });
            
            // Tenta limpeza e recupera√ß√£o
            await monitoringService.cleaningUp(instanceName);
            
        } catch (error) {
            console.error('Erro ao tratar falha de reconex√£o:', error);
        }
    });

    // Listener para logout de inst√¢ncia
    eventEmitter.on(EVENTS.LOGOUT_INSTANCE, async (instanceName, reason) => {
        console.log(`üö™ Logout da inst√¢ncia: ${instanceName}, motivo: ${reason}`);
        
        try {
            await emitEvent({
                instanceName,
                origin: 'whatsapp',
                event: 'LOGOUT_INSTANCE',
                data: { instanceName, reason, timestamp: new Date().toISOString() },
                serverUrl: process.env.SERVER_URL || 'http://localhost:3000',
                dateTime: new Date().toISOString(),
                sender: 'whatsapp-manager',
                local: false,
                integration: ['webhook']
            });
        } catch (error) {
            console.error('Erro ao processar logout:', error);
        }
    });

    // Listener para remo√ß√£o de inst√¢ncia
    eventEmitter.on(EVENTS.REMOVE_INSTANCE, async (instanceName, reason) => {
        console.log(`üóëÔ∏è Inst√¢ncia removida: ${instanceName}, motivo: ${reason}`);
        
        try {
            await emitEvent({
                instanceName,
                origin: 'whatsapp',
                event: 'REMOVE_INSTANCE',
                data: { instanceName, reason, timestamp: new Date().toISOString() },
                serverUrl: process.env.SERVER_URL || 'http://localhost:3000',
                dateTime: new Date().toISOString(),
                sender: 'whatsapp-manager',
                local: false,
                integration: ['webhook']
            });
        } catch (error) {
            console.error('Erro ao processar remo√ß√£o:', error);
        }
    });

    // Listener para sem conex√£o
    eventEmitter.on(EVENTS.NO_CONNECTION, async (instanceName) => {
        console.log(`‚ùå Sem conex√£o para: ${instanceName}`);
        
        try {
            await emitEvent({
                instanceName,
                origin: 'whatsapp',
                event: 'NO_CONNECTION',
                data: { instanceName, timestamp: new Date().toISOString() },
                serverUrl: process.env.SERVER_URL || 'http://localhost:3000',
                dateTime: new Date().toISOString(),
                sender: 'whatsapp-manager',
                local: false,
                integration: ['webhook']
            });
        } catch (error) {
            console.error('Erro ao processar falta de conex√£o:', error);
        }
    });

    // Listener para atualiza√ß√£o de conex√£o
    eventEmitter.on(EVENTS.CONNECTION_UPDATE, async (data) => {
        console.log(`üì° Status da conex√£o: ${data.state}`);
        
        try {
            await emitEvent({
                instanceName: data.instance || 'ZapBless',
                origin: 'whatsapp',
                event: 'CONNECTION_UPDATE',
                data: { ...data, timestamp: new Date().toISOString() },
                serverUrl: process.env.SERVER_URL || 'http://localhost:3000',
                dateTime: new Date().toISOString(),
                sender: 'whatsapp-manager',
                local: false,
                integration: ['webhook']
            });
        } catch (error) {
            console.error('Erro ao processar atualiza√ß√£o de conex√£o:', error);
        }
    });

    // Listener para QR Code atualizado
    eventEmitter.on(EVENTS.QRCODE_UPDATED, async (data) => {
        console.log(`üì± QR Code gerado para: ${data.qrcode?.instance}`);
        
        try {
            await emitEvent({
                instanceName: data.qrcode?.instance || 'ZapBless',
                origin: 'whatsapp',
                event: 'QRCODE_UPDATED',
                data: { 
                    qrcode: data.qrcode?.code,
                    pairingCode: data.qrcode?.pairingCode,
                    count: data.qrcode?.count,
                    timestamp: new Date().toISOString()
                },
                serverUrl: process.env.SERVER_URL || 'http://localhost:3000',
                dateTime: new Date().toISOString(),
                sender: 'whatsapp-manager',
                local: false,
                integration: ['webhook']
            });
        } catch (error) {
            console.error('Erro ao processar QR Code:', error);
        }
    });
}

/**
 * Exemplo de integra√ß√£o com o servidor WhatsApp existente
 */
function integrateWithWhatsAppServer(server) {
    console.log('üîó Integrando Event Controller com servidor WhatsApp...');

    // Adiciona o event emitter ao servidor
    server.eventEmitter = new EventEmitter();
    
    // Configura o monitoring service
    const monitoringService = new WAMonitoringService(
        server.eventEmitter,
        server.configService || { get: () => ({}) },
        server.supabaseRepository || new SupabaseRepository(),
        server.providerFiles || new ProviderFiles(),
        server.cache || { delete: async () => {}, keys: async () => [] },
        server.chatwootCache || { delete: async () => {}, keys: async () => [] },
        server.baileysCache || { delete: async () => {}, keys: async () => [] }
    );
    
    // Cria o event controller
    const eventController = new EventController(
        server.supabaseRepository || new SupabaseRepository(),
        monitoringService,
        true, // integrationStatus
        'webhook' // integrationName
    );
    
    // Adiciona ao servidor
    server.monitoringService = monitoringService;
    server.eventController = eventController;
    
    // Configura event listeners espec√≠ficos para WhatsApp
    setupWhatsAppEventListeners(server.eventEmitter, monitoringService, eventController);
    
    console.log('‚úÖ Event Controller integrado ao servidor WhatsApp');
}

/**
 * Exemplo de configura√ß√£o de webhook para integra√ß√µes
 */
async function setupWebhookIntegration(eventController, instanceName) {
    try {
        // Configura webhook para uma inst√¢ncia
        await eventController.set(instanceName, {
            webhook: {
                enabled: true,
                events: [
                    'MESSAGES_UPSERT',
                    'CONNECTION_UPDATE',
                    'QRCODE_UPDATED',
                    'RECONNECT_FAILED',
                    'LOGOUT_INSTANCE'
                ]
            }
        });

        console.log(`‚úÖ Webhook configurado para inst√¢ncia: ${instanceName}`);
        
        // Obt√©m configura√ß√£o atual
        const config = await eventController.get(instanceName);
        console.log('üìã Configura√ß√£o atual:', config);
        
    } catch (error) {
        console.error('‚ùå Erro ao configurar webhook:', error);
    }
}

/**
 * Exemplo de monitoramento de inst√¢ncias
 */
function setupInstanceMonitoring(monitoringService) {
    console.log('üìä Configurando monitoramento de inst√¢ncias...');
    
    // Monitora status das inst√¢ncias a cada 30 segundos
    setInterval(async () => {
        try {
            const instances = await monitoringService.instanceInfo();
            
            instances.forEach(instance => {
                const status = instance.connectionStatus;
                const name = instance.name;
                
                if (status === 'close') {
                    console.log(`‚ö†Ô∏è Inst√¢ncia ${name} est√° desconectada`);
                } else if (status === 'open') {
                    console.log(`‚úÖ Inst√¢ncia ${name} est√° conectada`);
                } else if (status === 'connecting') {
                    console.log(`üîÑ Inst√¢ncia ${name} est√° conectando...`);
                }
            });
            
        } catch (error) {
            console.error('‚ùå Erro no monitoramento:', error);
        }
    }, 30000);
}

/**
 * Exemplo de uso completo
 */
async function exampleWhatsAppIntegration() {
    try {
        console.log('üöÄ Iniciando integra√ß√£o do Event Controller com WhatsApp...\n');

        const { eventEmitter, monitoringService, eventController } = await setupEventControllerForWhatsApp();
        
        // Carrega inst√¢ncias existentes
        await monitoringService.loadInstance();
        
        // Configura monitoramento
        setupInstanceMonitoring(monitoringService);
        
        // Exemplo: configurar webhook para inst√¢ncia
        await setupWebhookIntegration(eventController, 'ZapBless');
        
        // Exemplo: salvar nova inst√¢ncia
        await monitoringService.saveInstance({
            instanceId: 'zapbless-instance-123',
            instanceName: 'ZapBless',
            ownerJid: '5512981606045@s.whatsapp.net',
            profileName: 'ZapBless Bot',
            profilePicUrl: null,
            integration: DEFAULT_CONFIG.INTEGRATION,
            number: '5512981606045',
            hash: 'zapbless-hash-123',
            businessId: null
        });
        
        console.log('\n‚úÖ Integra√ß√£o conclu√≠da com sucesso!');
        console.log('üì° Eventos sendo monitorados...');
        console.log('üîó Webhooks configurados...');
        console.log('üìä Monitoramento ativo...');
        
    } catch (error) {
        console.error('‚ùå Erro na integra√ß√£o:', error);
    }
}

/**
 * Fun√ß√£o para integrar com o servidor existente
 */
function integrateWithExistingServer(server) {
    try {
        // Integra o Event Controller
        integrateWithWhatsAppServer(server);
        
        // Configura monitoramento
        setupInstanceMonitoring(server.monitoringService);
        
        // Configura webhook para inst√¢ncia padr√£o
        setupWebhookIntegration(server.eventController, 'ZapBless');
        
        console.log('üéâ Event Controller integrado com sucesso ao servidor existente!');
        
    } catch (error) {
        console.error('‚ùå Erro ao integrar com servidor existente:', error);
    }
}

// -- STATEMENTS

// Executa o exemplo se o arquivo for executado diretamente
if (import.meta.url === `file://${process.argv[1]}`) {
    exampleWhatsAppIntegration().then(() => {
        console.log('\nüéâ Exemplo executado com sucesso');
        process.exit(0);
    }).catch((error) => {
        console.error('\nüí• Erro ao executar exemplo:', error);
        process.exit(1);
    });
}

export {
    setupEventControllerForWhatsApp,
    setupWhatsAppEventListeners,
    integrateWithWhatsAppServer,
    setupWebhookIntegration,
    setupInstanceMonitoring,
    exampleWhatsAppIntegration,
    integrateWithExistingServer
}; 