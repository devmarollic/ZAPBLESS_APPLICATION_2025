name: 📦 Build and Push WhatsApp Image

on:
  push:
    branches:
      - dev
    paths:
      - 'CODE/whatsapp_manager/**'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash

    env:
      APP_NAME: whatsapp-manager
      APP_TYPE: backend
      APP_VERSION: v1
      APP_MAIN: zapbless
      MIN_REPLICAS: 1
      MAX_REPLICAS: 1
      STABLE_MINUTES: 0

    steps:
      - name: 💾 Checkout Repository
        uses: actions/checkout@v3

      - name: 📁 Install Dependencies
        run: sudo apt-get update && sudo apt-get install -y jq curl python3

      - name: 🔢 Compute IMAGE_SUFFIX and Clean Registry
        run: |
          chmod +x ./scripts/script.sh
          source scripts/script.sh
          compute_image_suffix "$APP_NAME"
          echo "IMAGE_SUFFIX=$IMAGE_SUFFIX" >> $GITHUB_ENV
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: 🕒 Set Dynamic Tags
        run: |
          BUILD_DATE=$(date -u +"%Y%m%dT%H%M%SZ")
          IMAGE_TAG="${BUILD_DATE}-${GITHUB_RUN_ID}-${GITHUB_SHA::7}-${APP_NAME}-${IMAGE_SUFFIX}"
          IMAGE_REPO="ghcr.io/marollic/zapbless_application_2025"
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          echo "IMAGE_FULL=$IMAGE_REPO:$IMAGE_TAG" >> $GITHUB_ENV

      - name: 💪 Build Docker Image
        run: docker build -t $IMAGE_FULL CODE/whatsapp_manager

      - name: 🔐 Login to GitHub Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: 🚀 Push Image
        run: docker push $IMAGE_FULL

      - name: 🧑‍💻 Trigger Deployment to Main
        run: |
          source scripts/script.sh
          trigger_deployment "$APP_MAIN" "$APP_NAME" "$IMAGE_FULL" "$APP_VERSION" "$APP_TYPE" "$MIN_REPLICAS" "$MAX_REPLICAS" "$STABLE_MINUTES"
        env:
          GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}